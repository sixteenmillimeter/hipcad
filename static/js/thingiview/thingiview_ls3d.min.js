/*----------------------------------------------------
 * Thingiview
 *  -LS3D Branch
 * By M. McWilliams
 ---------------------------------------------------*//*global scope, Thingiview, $, document, window*/function log(e){this.console&&console.log(e);$(document).trigger("viewermsg",[e])}if(scope===undefined)var scope;var Thingiview=function(e){"use strict";function rt(){u=new THREE.Mesh(new Plane(100,100,10,10),new THREE.MeshBasicMaterial({color:11513775,wireframe:!0}));r.addObject(u)}function it(){if(r&&U){if(H=="wireframe")var e=new THREE.MeshBasicMaterial({color:B,wireframe:!0});else F?e=new THREE.MeshLambertMaterial({color:B,shading:THREE.FlatShading}):e=new THREE.MeshLambertMaterial({color:B,shading:THREE.FlatShading});if(o){o.materials=[new THREE.MeshBasicMaterial({color:16777215,opacity:0})];r.removeObject(o)}o=new THREE.Mesh(U,e);r.addObject(o);if(H!="wireframe"){o.overdraw=!0;o.doubleSided=!0}o.updateMatrix();c=0;v=0;tt()}}scope=this;this.containerId=e;var t=document.getElementById(e),n=null,r=null,s=null,o=null,u=null,a=null,f=null,l=null,c=0,h=0,p=0,d=0,v=0,m=0,g=0,y=0,b=!1,w=!1,E=window.innerWidth/2,S=window.innerHeight/2,x=null,T=null,N=null,C=null,k=null,L=null,A=null,O=null,M="diagonal",_=0,D=!1,P="#606060",H="solid",B=16777215,j=!0,F=!1,I=24;if(document.defaultView&&document.defaultView.getComputedStyle)var q=parseFloat(document.defaultView.getComputedStyle(t,null).getPropertyValue("width")),R=parseFloat(document.defaultView.getComputedStyle(t,null).getPropertyValue("height"));else var q=parseFloat(t.currentStyle.width),R=parseFloat(t.currentStyle.height);var U;this.initScene=function(){t.style.position="relative";t.innerHTML="";n=new THREE.Camera(45,q/R,1,1e5);n.updateMatrix();r=new THREE.Scene;a=new THREE.AmbientLight(2105376);r.addLight(a);f=new THREE.DirectionalLight(16777215,.75);f.position.x=1;f.position.y=1;f.position.z=2;f.position.normalize();r.addLight(f);l=new THREE.PointLight(16777215,.3);l.position.x=0;l.position.y=-25;l.position.z=10;r.addLight(l);N=document.createElement("div");N.style.position="absolute";N.style.top="0px";N.style.left="0px";N.style.backgroundColor="red";N.style.padding="5px";N.style.display="none";N.style.overflow="visible";N.style.whiteSpace="nowrap";N.style.zIndex=100;t.appendChild(N);C=document.createElement("div");C.id="alertBox";C.style.position="absolute";C.style.top="25%";C.style.left="25%";C.style.width="50%";C.style.height="50%";C.style.backgroundColor="#dddddd";C.style.padding="10px";C.style.display="none";C.style.zIndex=100;t.appendChild(C);j&&rt();this.setCameraView(M);this.setObjectMaterial(H);var e=document.createElement("canvas");try{if(e.getContext("experimental-webgl")){F=!0;s=new THREE.WebGLRenderer}else s=new THREE.CanvasRenderer}catch(i){s=new THREE.CanvasRenderer}s.setSize(q,R);s.domElement.style.backgroundColor=P;t.appendChild(s.domElement);window.addEventListener("mousemove",K,!1);s.domElement.addEventListener("mouseover",V,!1);s.domElement.addEventListener("mouseout",G,!1);s.domElement.addEventListener("mousedown",J,!1);window.addEventListener("mouseup",Q,!1);s.domElement.addEventListener("touchstart",Y,!1);s.domElement.addEventListener("touchend",Z,!1);s.domElement.addEventListener("touchmove",et,!1);s.domElement.addEventListener("DOMMouseScroll",W,!1);s.domElement.addEventListener("mousewheel",W,!1);s.domElement.addEventListener("gesturechange",X,!1)};var z=function(e,t){if(s){s.setSize(e,t);n.projectionMatrix=THREE.Matrix4.makePerspective(70,e/t,1,1e4);tt()}},W=function(e){e.preventDefault();var t=0;e.wheelDelta===undefined?t=-40*e.detail:t=e.wheelDelta;t>0?scope.setCameraZoom(10):scope.setCameraZoom(-10)},X=function(e){e.preventDefault();e.scale>1?scope.setCameraZoom(5):scope.setCameraZoom(-5)},V=function(e){w=!0},J=function(e){e.preventDefault();b=!0;k==null&&(k=setInterval(tt,1e3/I));if(scope.getRotation()){O=!0;scope.setRotation(!1)}else O=!1;d=e.clientX-E;y=e.clientY-S;h=c;m=v},K=function(e){if(b){p=e.clientX-E;var t=h+(p-d)*.02;g=e.clientY-S;var n=m+(g-y)*.02;c=t;v=n}},Q=function(e){if(b){b=!1;clearInterval(k);k=null;O&&scope.setRotation(!0)}},G=function(e){if(b&&k!==null){clearInterval(k);k=null}w=!1},Y=function(e){c=o.rotation.z;v=o.rotation.x;k=setInterval(tt,1e3/I);if(e.touches.length==1){e.preventDefault();d=e.touches[0].pageX-E;h=c;y=e.touches[0].pageY-S;m=v}},Z=function(e){clearInterval(k);k=null},et=function(e){if(e.touches.length==1){e.preventDefault();p=e.touches[0].pageX-E;c=h+(p-d)*.05;g=e.touches[0].pageY-S;v=m+(g-y)*.05}},tt=function(){if(o){if(j){u.rotation.z=o.rotation.z=(c-o.rotation.z)*.2;u.rotation.x=o.rotation.x=(v-o.rotation.x)*.2}else{o.rotation.z=(c-o.rotation.z)*.2;o.rotation.x=(v-o.rotation.x)*.2}n.updateMatrix();o.updateMatrix();j&&u.updateMatrix();s.render(r,n)}},nt=function(){c+=.05;tt()};this.getShowPlane=function(){return j};this.setShowPlane=function(e){j=e;if(e){r&&!u&&rt();u.material[0].opacity=1}else r&&u&&(u.material[0].opacity=0);tt()};this.getRotation=function(){return L!==null};this.setRotation=function(e){var t=e;if(e)L=setInterval(nt,1e3/I);else{clearInterval(L);L=null}scope.onSetRotation()};this.onSetRotation=function(e){if(e===undefined){if(A!==null)try{A(scope.getRotation())}catch(t){}}else A=e};this.setCameraView=function(e){M=e;c=0;v=0;if(o){o.rotation.x=0;o.rotation.y=0;o.rotation.z=0}if(j&&o){u.rotation.x=o.rotation.x;u.rotation.y=o.rotation.y;u.rotation.z=o.rotation.z}if(e=="top")j&&(u.flipSided=!1);else if(e=="side"){v=-4.5;j&&(u.flipSided=!1)}else e=="bottom"?j&&(u.flipSided=!0):j&&(u.flipSided=!1);p=c;d=c;g=v;y=v;scope.centerCamera();tt()};this.setSize=function(){};this.setCameraZoom=function(e){_=e;M=="bottom"?n.position.z+e>0&&(e=0):n.position.z-e<0&&(e=0);if(M=="top")n.position.z-=e;else if(M=="bottom")n.position.z+=e;else if(M=="side"){n.position.y+=e;n.position.z-=e}else{n.position.y+=e;n.position.z-=e}tt()};this.getCameraZoom=function(){return n};this.setCameraPos=function(e){o.rotation.x=e.objRot.x;u.rotation.x=e.planeRot.x;n.position.x=e.cameraPos.x;o.rotation.y=e.objRot.y;u.rotation.y=e.planeRot.y;n.position.y=e.cameraPos.y;o.rotation.z=e.objRot.z;u.rotation.z=e.planeRot.z;n.position.z=e.cameraPos.z;v=e.targetY;c=e.targetX;n.updateMatrix();o.updateMatrix();u.updateMatrix();s.render(r,n)};this.getCameraPos=function(){return{objRot:{x:o.rotation.x,y:o.rotation.y,z:o.rotation.z},planeRot:{x:u.rotation.x,y:u.rotation.y,z:u.rotation.z},cameraPos:{x:n.position.x,y:n.position.y,z:n.position.z},targetY:v,targetX:c}};this.getObjectMaterial=function(){return H};this.setObjectMaterial=function(e){H=e;it()};this.setBackgroundColor=function(e){P=e;s&&(s.domElement.style.backgroundColor=e)};this.setObjectColor=function(e){B=parseInt(e.replace(/\#/g,""),16);it()};this.loadSTL=function(e){scope.newWorker("loadSTL",e)};this.loadOBJ=function(e){scope.newWorker("loadOBJ",e)};this.loadSTLString=function(e){scope.newWorker("loadSTLString",e)};this.loadSTLBinary=function(e){scope.newWorker("loadSTLBinary",e)};this.loadOBJString=function(e){scope.newWorker("loadOBJString",e)};this.loadJSON=function(e){scope.newWorker("loadJSON",e)};this.loadPLY=function(e){scope.newWorker("loadPLY",e)};this.loadPLYString=function(e){scope.newWorker("loadPLYString",e)};this.loadPLYBinary=function(e){scope.newWorker("loadPLYBinary",e)};this.centerCamera=function(){if(U){n.target.position.x=U.center_x;n.target.position.y=U.center_y;n.target.position.z=U.center_z;n.position.x=U.center_x;n.position.y=U.center_y;n.position.z=U.center_z;var e=U.boundingSphere.radius/Math.sin(n.fov/2*(Math.PI/180));scope.setCameraZoom(-e/1.9);f.position.x=U.min_y*2;f.position.y=U.min_y*2;f.position.z=U.max_z*2;l.position.x=U.center_y;l.position.y=U.center_y;l.position.z=U.max_z*2}else{n.position.y=-70;n.position.z=70;n.target.position.z=0}};this.loadArray=function(e){log("loading array...");U=new STLGeometry(e);it();scope.setRotation(!1);scope.setRotation(!0);scope.centerCamera();log("finished loading "+U.faces.length+" faces.")};this.newWorker=function(e,t){scope.setRotation(!1);var o=new WorkerFacade(thingiurlbase+"/thingiloader.js");o.onmessage=function(e){if(e.data.status=="complete"){N.innerHTML="Initializing geometry...";U=new STLGeometry(e.data.content);it();N.innerHTML="";N.style.display="none";scope.setRotation(!1);$(document).trigger("loadedstl");log("Finished loading "+U.faces.length+" faces.")}else if(e.data.status=="complete_points"){N.innerHTML="Initializing points...";U=new THREE.Geometry;var t=new THREE.ParticleBasicMaterial({color:16711680,opacity:1});for(i in e.data.content[0]){vector=new THREE.Vector3(e.data.content[0][i][0],e.data.content[0][i][1],e.data.content[0][i][2]);U.vertices.push(new THREE.Vertex(vector))}particles=new THREE.ParticleSystem(U,t);particles.sortParticles=!0;particles.updateMatrix();r.addObject(particles);n.updateMatrix();s.render(r,n);N.innerHTML="";N.style.display="none";scope.setRotation(!1);log("finished loading "+e.data.content[0].length+" points.")}else if(e.data.status=="progress"){N.style.display="block";N.style.width=e.data.content}else if(e.data.status=="message"){N.style.display="block";N.innerHTML=e.data.content;log(e.data.content)}else if(e.data.status=="alert")scope.displayAlert(e.data.content);else{alert("Error: "+e.data);log("Unknown Worker Message: "+e.data)}};o.onerror=function(e){log(e);e.preventDefault()};o.postMessage({cmd:e,param:t})};this.displayAlert=function(e){e+='<br/><br/><center><input type="button" value="Ok" onclick="document.getElementById(\'alertBox\').style.display=\'none\'"></center>';C.innerHTML=e;C.style.display="block"}},STLGeometry=function(e){function r(e,n,r){t.vertices.push(new THREE.Vertex(new THREE.Vector3(e,n,r)))}function i(e,n,r){t.faces.push(new THREE.Face3(e,n,r))}THREE.Geometry.call(this);var t=this;for(var n=0;n<e[0].length;n++)r(e[0][n][0],e[0][n][1],e[0][n][2]);for(var n=0;n<e[1].length;n++)i(e[1][n][0],e[1][n][1],e[1][n][2]);this.computeCentroids();this.computeFaceNormals();this.sortFacesByMaterial();t.min_x=0;t.min_y=0;t.min_z=0;t.max_x=0;t.max_y=0;t.max_z=0;for(var r=0,s=t.vertices.length;r<s;r++){t.max_x=Math.max(t.max_x,t.vertices[r].position.x);t.max_y=Math.max(t.max_y,t.vertices[r].position.y);t.max_z=Math.max(t.max_z,t.vertices[r].position.z);t.min_x=Math.min(t.min_x,t.vertices[r].position.x);t.min_y=Math.min(t.min_y,t.vertices[r].position.y);t.min_z=Math.min(t.min_z,t.vertices[r].position.z)}t.center_x=(t.max_x+t.min_x)/2;t.center_y=(t.max_y+t.min_y)/2;t.center_z=(t.max_z+t.min_z)/2};STLGeometry.prototype=new THREE.Geometry;STLGeometry.prototype.constructor=STLGeometry;var WorkerFacade;window.Worker?WorkerFacade=function(){return function(e){return new window.Worker(e)}}():WorkerFacade=function(){var e={},t={},n=!1,r=function(n){var r={},i=!1,s=[];r.postToWorkerFunction=function(t){try{e[n]({data:t})}catch(i){r.onerror(i)}};r.postMessage=function(e){if(!i){s.push(e);return}r.postToWorkerFunction(e)};t[n]=r;var o=document.createElement("SCRIPT");o.src=n;o.type="text/javascript";o.onload=function(){i=!0;while(s.length>0){r.postToWorkerFunction(s[0]);s.shift()}};document.body.appendChild(o);var u=document.createElement("SCRIPT");u.src=thingiurlbase+"/binaryReader.js";u.type="text/javascript";document.body.appendChild(u);return r};r.fake=!0;r.add=function(n,r){e[n]=r;return function(e){t[n].onmessage({data:e})}};r.toString=function(){return"FakeWorker('"+path+"')"};return r}();