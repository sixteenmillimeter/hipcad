Thingiloader=function(event){this.load_binary_resource=function(e){var t=new XMLHttpRequest;t.open("GET",e,!1);t.overrideMimeType("text/plain; charset=x-user-defined");t.send(null);return t.status!=200?"":t.responseText};this.loadSTL=function(e){var t=function(e){e.seek(80);var t=e.readUInt32(),n=84+50*t;return e.getSize()==n};workerFacadeMessage({status:"message",content:"Downloading "+e});var n=this.load_binary_resource(e),r=new BinaryReader(n);t(r)?this.loadSTLBinary(r):this.loadSTLString(n)};this.loadOBJ=function(e){workerFacadeMessage({status:"message",content:"Downloading "+e});var t=this.load_binary_resource(e);this.loadOBJString(t)};this.loadJSON=function(e){workerFacadeMessage({status:"message",content:"Downloading "+e});var t=this.load_binary_resource(e);this.loadJSONString(t)};this.loadPLY=function(e){workerFacadeMessage({status:"message",content:"Downloading "+e});var t=this.load_binary_resource(e);t.match(/format ascii/i)?this.loadPLYString(t):this.loadPLYBinary(t)};this.loadSTLString=function(e){workerFacadeMessage({status:"message",content:"Parsing STL String..."});workerFacadeMessage({status:"complete",content:this.ParseSTLString(e)})};this.loadSTLBinary=function(e){workerFacadeMessage({status:"message",content:"Parsing STL Binary..."});workerFacadeMessage({status:"complete",content:this.ParseSTLBinary(e)})};this.loadOBJString=function(e){workerFacadeMessage({status:"message",content:"Parsing OBJ String..."});workerFacadeMessage({status:"complete",content:this.ParseOBJString(e)})};this.loadJSONString=function(JSONString){workerFacadeMessage({status:"message",content:"Parsing JSON String..."});workerFacadeMessage({status:"complete",content:eval(JSONString)})};this.loadPLYString=function(e){workerFacadeMessage({status:"message",content:"Parsing PLY String..."});workerFacadeMessage({status:"complete_points",content:this.ParsePLYString(e)})};this.loadPLYBinary=function(e){workerFacadeMessage({status:"message",content:"Parsing PLY Binary..."});workerFacadeMessage({status:"complete_points",content:this.ParsePLYBinary(e)})};this.ParsePLYString=function(e){var t=[],n=[],r=[],s=0,o=/ply\n([\s\S]+)\nend_header/ig.exec(e)[1],u=/end_header\n([\s\S]+)$/ig.exec(e)[1];header_parts=o.split("\n");for(i in header_parts)/element vertex/i.test(header_parts[i])?s=/element vertex (\d+)/i.exec(header_parts[i])[1]:/property/i.test(header_parts[i])&&t.push(/property (.*) (.*)/i.exec(header_parts[i])[2]);data_parts=u.split("\n");for(i in data_parts){data_line=data_parts[i];data_line_parts=data_line.split(" ");n.push([parseFloat(data_line_parts[t.indexOf("x")]),parseFloat(data_line_parts[t.indexOf("y")]),parseFloat(data_line_parts[t.indexOf("z")])]);r.push([parseInt(data_line_parts[t.indexOf("red")]),parseInt(data_line_parts[t.indexOf("green")]),parseInt(data_line_parts[t.indexOf("blue")])])}return[n,r]};this.ParsePLYBinary=function(e){return!1};this.ParseSTLBinary=function(e){e.seek(80);var t=e.readUInt32(),n=[],r={},i=[];for(var s=0;s<t;s++){if(s%100==0){workerFacadeMessage({status:"message",content:"Parsing "+(s+1)+" of "+t+" polygons..."});workerFacadeMessage({status:"progress",content:parseInt(s/t*100)+"%"})}e.seek(e.getPosition()+12);var o=[];for(var u=0;u<3;u++){var a=[e.readFloat(),e.readFloat(),e.readFloat()],f=r[a];if(f==null){f=n.length;n.push(a);r[a]=f}o.push(f)}i.push(o);e.readUInt16()}return[n,i]};this.ParseSTLString=function(e){var t=[],n=[],r=[],i={};e=e.replace(/\r/,"\n");e=e.replace(/^solid[^\n]*/,"");e=e.replace(/\n/g," ");e=e.replace(/facet normal /g,"");e=e.replace(/outer loop/g,"");e=e.replace(/vertex /g,"");e=e.replace(/endloop/g,"");e=e.replace(/endfacet/g,"");e=e.replace(/endsolid[^\n]*/,"");e=e.replace(/\s+/g," ");e=e.replace(/^\s+/,"");var s=0,o=0,u=e.split(" ");workerFacadeMessage({status:"message",content:"Parsing vertices..."});for(var a=0;a<u.length/12-1;a++){a%100==0&&workerFacadeMessage({status:"progress",content:parseInt(a/(u.length/12-1)*100)+"%"});var f=[];for(var l=0;l<3;l++){var c=[parseFloat(u[o+l*3+3]),parseFloat(u[o+l*3+4]),parseFloat(u[o+l*3+5])],h=i[c];if(h==null){h=t.length;t.push(c);i[c]=h}f.push(h)}n.push(f);o+=12}return[t,n]};this.ParseOBJString=function(e){var t=[],n=[],r=e.split("\n");for(var i=0;i<r.length;i++){workerFacadeMessage({status:"progress",content:parseInt(i/r.length*100)+"%"});line_parts=r[i].replace(/\s+/g," ").split(" ");line_parts[0]=="v"?t.push([parseFloat(line_parts[1]),parseFloat(line_parts[2]),parseFloat(line_parts[3])]):line_parts[0]=="f"&&n.push([parseFloat(line_parts[1].split("/")[0])-1,parseFloat(line_parts[2].split("/")[0])-1,parseFloat(line_parts[3].split("/")[0]-1),0])}return[t,n]};switch(event.data.cmd){case"loadSTL":this.loadSTL(event.data.param);break;case"loadSTLString":this.loadSTLString(event.data.param);break;case"loadSTLBinary":this.loadSTLBinary(event.data.param);break;case"loadOBJ":this.loadOBJ(event.data.param);break;case"loadOBJString":this.loadOBJString(event.data.param);break;case"loadJSON":this.loadJSON(event.data.param);break;case"loadPLY":this.loadPLY(event.data.param);break;case"loadPLYString":this.loadPLYString(event.data.param);break;case"loadPLYBinary":this.loadPLYBinary(event.data.param)}};if(typeof window=="undefined"){onmessage=Thingiloader;workerFacadeMessage=postMessage;importScripts("binaryReader.js")}else workerFacadeMessage=WorkerFacade.add(thingiurlbase+"/thingiloader.js",Thingiloader);